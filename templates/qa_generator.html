<!-- Copyright 2026 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q&A Generator - TalentCore AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading { display: none; }
        .question-card { margin-bottom: 15px; border-left: 4px solid #007bff; }
        .fast-response { animation: fadeIn 0.3s ease-in; }
        .history-item:hover { background-color: #f8f9fa; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand d-flex flex-column align-items-center" href="/">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="TalentCore AI" height="30">
                <small>TalentCore AI</small>
            </a>
            <span class="navbar-text">Q&A Generator</span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Generate Questions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">Job Description *</label>
                        <textarea class="form-control" id="jobDescription" rows="4" placeholder="Paste the complete job description here..."></textarea>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Experience Level *</label>
                        <input type="text" class="form-control" id="experienceLevel" placeholder="e.g., 2 years, 5+ years, Senior">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Skill Level *</label>
                        <select class="form-select" id="skillLevel">
                            <option value="">Select Skill Level</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                            <option value="expert">Expert</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Question Type *</label>
                        <select class="form-select" id="questionType">
                            <option value="">Select Question Type</option>
                            <option value="technical">Technical</option>
                            <option value="technical-scenario">Technical + Scenario Based</option>
                            <option value="technical-coding">Technical + Coding</option>
                            <option value="behavioral">Behavioral</option>
                            <option value="competency-based">Competency-based</option>
                            <option value="situational">Situational</option>
                            <option value="skill-based">Skill-based</option>
                            <option value="mixed">Mixed (All Types)</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <button class="btn btn-primary btn-lg" onclick="generateQuestions()">
                            <span class="loading spinner-border spinner-border-sm me-2"></span>
                            Generate Q&A
                        </button>
                    </div>
                </div>

                <div class="mt-2">
                    <small class="text-muted" id="cacheStatus"></small>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between">
                <h5>Generated Questions & Answers</h5>
                <small class="text-muted" id="responseTime"></small>
            </div>
            <div class="card-body">
                <div id="questionsContainer">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-lightbulb fa-3x mb-3"></i>
                        <h5>Ready to Generate Interview Questions</h5>
                        <p>Fill in the job description and requirements above, then click "Generate Q&A" to create customized interview questions and answers.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="card">
            <div class="card-header">
                <h6>Recent History</h6>
            </div>
            <div class="card-body">
                <div id="historyContainer">
                    <div class="text-center text-muted">
                        <small>Loading history...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cache for fast responses
        const qaCache = new Map();
        

        
        // Clear cache when inputs change
        ['experienceLevel', 'skillLevel', 'questionType'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                qaCache.clear();
                document.getElementById('cacheStatus').textContent = 'Settings changed - questions will be regenerated';
            });
        });
        
        // Clear cache when job description changes
        document.getElementById('jobDescription').addEventListener('input', function() {
            qaCache.clear();
            document.getElementById('cacheStatus').textContent = 'Job description changed - questions will be regenerated';
        });

        async function generateQuestions() {
            const startTime = Date.now();
            const jobDescription = document.getElementById('jobDescription').value;
            const experienceLevel = document.getElementById('experienceLevel').value;
            const skillLevel = document.getElementById('skillLevel').value;
            const questionType = document.getElementById('questionType').value;
            
            // Validation
            if (!jobDescription.trim()) {
                alert('Please enter a job description');
                return;
            }
            
            if (!experienceLevel.trim()) {
                alert('Please enter an experience level');
                return;
            }
            
            if (!skillLevel) {
                alert('Please select a skill level');
                return;
            }
            
            if (!questionType) {
                alert('Please select a question type');
                return;
            }

            // Create cache key
            const cacheKey = `jd-${jobDescription.length}-${experienceLevel}-${skillLevel}-${questionType}-${Date.now()}`;
            
            document.getElementById('cacheStatus').textContent = 'Generating questions based on your requirements...';

            const button = document.querySelector('button');
            const loading = document.querySelector('.loading');
            
            button.disabled = true;
            loading.style.display = 'inline-block';

            try {
                const payload = {
                    jobDescription: jobDescription,
                    experienceLevel: experienceLevel,
                    skillLevel: skillLevel,
                    questionType: questionType
                };
                
                console.log('Sending payload:', payload);

                const response = await fetch('/generate-qa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Cache the result
                qaCache.set(cacheKey, data);
                
                // Store for customization
                currentQuestions = data.questions || [];
                currentContext = {
                    jobDescription: jobDescription,
                    experienceLevel: experienceLevel,
                    skillLevel: skillLevel,
                    questionType: questionType
                };
                
                displayQuestions(data);
                
                const responseTime = Date.now() - startTime;
                document.getElementById('responseTime').textContent = `Generated in ${responseTime}ms`;
                document.getElementById('cacheStatus').textContent = 'Questions generated successfully';
                
                // Refresh history
                loadHistory();

            } catch (error) {
                document.getElementById('questionsContainer').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayQuestions(data) {
            const container = document.getElementById('questionsContainer');
            
            if (!data.questions || data.questions.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No questions generated</div>';
                return;
            }

            let html = '';
            data.questions.forEach((qa, index) => {
                html += `
                    <div class="card question-card fast-response">
                        <div class="card-body">
                            <h6 class="card-title text-primary">Question ${index + 1}</h6>
                            <p class="card-text"><strong>${qa.question}</strong></p>
                            <div class="mt-3">
                                <h6 class="text-success">Sample Answer:</h6>
                                <p class="text-muted">${qa.answer}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Store current questions globally for customization
        let currentQuestions = [];
        let currentContext = {};
        // Load history on page load
        window.addEventListener('load', () => {
            loadHistory();
        });
        
        async function loadHistory() {
            try {
                const response = await fetch('/api/qa-history');
                const data = await response.json();
                console.log('History data:', data);  // Debug logging
                displayHistory(data.history || []);
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyContainer').innerHTML = 
                    '<small class="text-muted">Error loading history</small>';
            }
        }
        
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<small class="text-muted">No previous sessions found. Generate some questions to see history here.</small>';
                return;
            }
            
            let html = '';
            history.forEach(item => {
                const experienceText = item.experience_level ? 
                    `${item.experience_level.charAt(0).toUpperCase() + item.experience_level.slice(1)} Experience` : '';
                
                const skillText = item.skill_level ? 
                    `${item.skill_level.charAt(0).toUpperCase() + item.skill_level.slice(1)} Skill` : '';
                
                const questionTypeText = item.question_type ? 
                    `${item.question_type.charAt(0).toUpperCase() + item.question_type.slice(1)} Questions` : '';
                
                const dateText = item.timestamp ? 
                    (item.timestamp.seconds ? 
                        new Date(item.timestamp.seconds * 1000).toLocaleDateString() : 
                        new Date(item.timestamp).toLocaleDateString()) : 'Recent';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom history-item" 
                         style="cursor: pointer;" onclick="viewHistorySession('${item.session_id}')">
                        <div>
                            <strong>Q&A Session</strong><br>
                            <small class="text-muted">${experienceText} • ${skillText} • ${questionTypeText} • ${item.question_count} Questions</small>
                        </div>
                        <small class="text-muted">${dateText}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function viewHistorySession(sessionId) {
            try {
                const response = await fetch(`/api/qa-history/${sessionId}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Display the historical session
                displayQuestions(data);
                
                // Update status
                document.getElementById('cacheStatus').textContent = 'Loaded historical session';
                
            } catch (error) {
                console.error('Error loading session:', error);
                document.getElementById('cacheStatus').textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>