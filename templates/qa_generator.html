<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q&A Generator - TalentCore AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading { display: none; }
        .question-card { margin-bottom: 15px; border-left: 4px solid #007bff; }
        .fast-response { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">TalentCore AI</a>
            <span class="navbar-text">Q&A Generator</span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Generate Questions</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Method</label>
                            <select class="form-select" id="method">
                                <option value="title">Job Title</option>
                                <option value="jd">Job Description</option>
                            </select>
                        </div>

                        <div id="titleInputs">
                            <div class="mb-3">
                                <label class="form-label">Job Title</label>
                                <input type="text" class="form-control" id="jobTitle" placeholder="e.g., Senior Software Engineer">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Experience Level</label>
                                <select class="form-select" id="experienceLevel">
                                    <option value="0-1 years">Entry Level (0-1 years)</option>
                                    <option value="2+ years">Junior Level (2+ years)</option>
                                    <option value="3-4 years">Mid Level (3-4 years)</option>
                                    <option value="5+ years">Senior Level (5+ years)</option>
                                    <option value="7+ years">Lead Level (7+ years)</option>
                                    <option value="10+ years">Principal Level (10+ years)</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Job Description (Optional)</label>
                            <textarea class="form-control" id="jobDescription" rows="4" placeholder="Paste job description for more targeted questions..."></textarea>
                        </div>

                        <button class="btn btn-primary w-100" onclick="generateQuestions()">
                            <span class="loading spinner-border spinner-border-sm me-2"></span>
                            Generate Questions
                        </button>
                        
                        <div class="mt-2">
                            <small class="text-muted" id="cacheStatus"></small>
                        </div>
                        
                        <!-- Chatbot Interface -->
                        <div class="mt-3" id="chatInterface" style="display: none;">
                            <hr>
                            <h6>Customize Questions</h6>
                            <div class="mb-2">
                                <input type="text" class="form-control" id="userRequest" placeholder="e.g., Make questions more technical, Add leadership questions, etc.">
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="customizeQuestions()">
                                <span class="loading-custom spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                Customize
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5>Generated Questions & Answers</h5>
                        <small class="text-muted" id="responseTime"></small>
                    </div>
                    <div class="card-body">
                        <div id="questionsContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-lightbulb fa-3x mb-3"></i>
                                <p>Generate questions to see them here</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- History Section -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6>Recent History</h6>
                    </div>
                    <div class="card-body">
                        <div id="historyContainer">
                            <div class="text-center text-muted">
                                <small>Loading history...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cache for fast responses
        const qaCache = new Map();
        
        document.getElementById('method').addEventListener('change', function() {
            const titleInputs = document.getElementById('titleInputs');
            titleInputs.style.display = this.value === 'title' ? 'block' : 'none';
        });
        
        // Clear cache when experience level changes
        document.getElementById('experienceLevel').addEventListener('change', function() {
            const jobTitle = document.getElementById('jobTitle').value;
            if (jobTitle.trim()) {
                // Clear cache for this job title to force regeneration
                for (let key of qaCache.keys()) {
                    if (key.startsWith(jobTitle.toLowerCase())) {
                        qaCache.delete(key);
                    }
                }
                document.getElementById('cacheStatus').textContent = 'Experience level changed - questions will be regenerated';
                console.log('Cache cleared for experience level change');
            }
        });
        
        // Clear cache when job title changes
        document.getElementById('jobTitle').addEventListener('input', function() {
            // Clear cache when job title changes significantly
            if (this.value.length > 3) {
                for (let key of qaCache.keys()) {
                    if (!key.startsWith(this.value.toLowerCase())) {
                        qaCache.delete(key);
                    }
                }
            }
        });
        
        // Clear cache when job description changes
        document.getElementById('jobDescription').addEventListener('input', function() {
            // Clear all cache when job description changes
            qaCache.clear();
            document.getElementById('cacheStatus').textContent = 'Job description changed - questions will be regenerated';
        });

        async function generateQuestions() {
            const startTime = Date.now();
            const method = document.getElementById('method').value;
            const jobTitle = document.getElementById('jobTitle').value;
            const experienceLevel = document.getElementById('experienceLevel').value;
            const jobDescription = document.getElementById('jobDescription').value;
            
            if (method === 'title' && !jobTitle.trim()) {
                alert('Please enter a job title');
                return;
            }
            
            if (method === 'jd' && !jobDescription.trim()) {
                alert('Please enter a job description');
                return;
            }

            // Create cache key that includes full content and timestamp to prevent stale cache
            const cacheKey = method === 'title' 
                ? `${jobTitle.toLowerCase()}-${experienceLevel}-${Date.now()}`
                : `jd-${jobDescription.length}-${Date.now()}`;
            
            // Clear cache if experience level changed to force regeneration
            if (method === 'title') {
                // Remove any cached entries for this job title with different experience levels
                for (let key of qaCache.keys()) {
                    if (key.startsWith(jobTitle.toLowerCase()) && !key.includes(experienceLevel)) {
                        qaCache.delete(key);
                    }
                }
            }
            
            // Temporarily disable cache to ensure fresh API calls
            // if (qaCache.has(cacheKey)) {
            //     displayQuestions(qaCache.get(cacheKey));
            //     document.getElementById('responseTime').textContent = 'Cached response (instant)';
            //     document.getElementById('cacheStatus').textContent = 'Using cached questions';
            //     return;
            // }
            
            document.getElementById('cacheStatus').textContent = 'Generating new questions for this experience level...';

            const button = document.querySelector('button');
            const loading = document.querySelector('.loading');
            
            button.disabled = true;
            loading.style.display = 'inline-block';

            try {
                const payload = { method };
                
                if (method === 'title') {
                    payload.jobTitle = jobTitle;
                    payload.experienceLevel = experienceLevel;
                    if (jobDescription.trim()) {
                        payload.jobDescription = jobDescription;
                    }
                    console.log('Sending TITLE method payload:', payload);
                } else if (method === 'jd') {
                    payload.jobDescription = jobDescription;
                    payload.experienceLevel = experienceLevel;
                    console.log('Sending JD method payload:', payload);
                }

                const response = await fetch('/generate-qa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Cache the result
                qaCache.set(cacheKey, data);
                
                // Store for customization
                currentQuestions = data.questions || [];
                currentContext = {
                    method: method,
                    jobTitle: method === 'title' ? jobTitle : null,
                    experienceLevel: experienceLevel,
                    jobDescription: jobDescription
                };
                
                displayQuestions(data);
                
                const responseTime = Date.now() - startTime;
                document.getElementById('responseTime').textContent = `Generated in ${responseTime}ms`;
                document.getElementById('cacheStatus').textContent = 'Questions generated successfully';
                
                // Refresh history
                loadHistory();

            } catch (error) {
                document.getElementById('questionsContainer').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayQuestions(data) {
            const container = document.getElementById('questionsContainer');
            
            if (!data.questions || data.questions.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No questions generated</div>';
                return;
            }

            let html = '';
            data.questions.forEach((qa, index) => {
                html += `
                    <div class="card question-card fast-response">
                        <div class="card-body">
                            <h6 class="card-title text-primary">Question ${index + 1}</h6>
                            <p class="card-text"><strong>${qa.question}</strong></p>
                            <div class="mt-3">
                                <h6 class="text-success">Sample Answer:</h6>
                                <p class="text-muted">${qa.answer}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // Show customize interface after questions are displayed
            document.getElementById('chatInterface').style.display = 'block';
        }

        // Store current questions globally for customization
        let currentQuestions = [];
        let currentContext = {};
        
        async function customizeQuestions() {
            const userRequest = document.getElementById('userRequest').value.trim();
            if (!userRequest) {
                alert('Please enter your customization request');
                return;
            }
            
            const loadingCustom = document.querySelector('.loading-custom');
            const button = document.querySelector('#chatInterface button');
            
            button.disabled = true;
            loadingCustom.style.display = 'inline-block';
            
            try {
                const response = await fetch('/customize-qa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userRequest: userRequest,
                        currentQuestions: currentQuestions,
                        context: currentContext
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update current questions and display
                currentQuestions = data.questions;
                displayQuestions(data);
                
                // Clear input
                document.getElementById('userRequest').value = '';
                document.getElementById('cacheStatus').textContent = 'Questions customized successfully';
                
            } catch (error) {
                document.getElementById('cacheStatus').textContent = `Error: ${error.message}`;
            } finally {
                button.disabled = false;
                loadingCustom.style.display = 'none';
            }
        }
        // Preload common roles for instant responses with different experience levels
        const commonRoles = [
            'Software Engineer', 'Data Scientist', 'Product Manager', 
            'DevOps Engineer', 'Frontend Developer', 'Backend Developer'
        ];
        const experienceLevels = ['2+ years', '5+ years'];
        
        // Preload cache on page load
        window.addEventListener('load', () => {
            loadHistory();
            
            commonRoles.forEach(role => {
                experienceLevels.forEach(exp => {
                    setTimeout(() => {
                        fetch('/generate-qa', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                method: 'title',
                                jobTitle: role,
                                experienceLevel: exp
                            })
                        }).then(r => r.json()).then(data => {
                            qaCache.set(`${role.toLowerCase()}-${exp}-`, data);
                        }).catch(() => {});
                    }, Math.random() * 3000);
                });
            });
        });
        
        async function loadHistory() {
            try {
                const response = await fetch('/api/qa-history');
                const data = await response.json();
                console.log('History data:', data);  // Debug logging
                displayHistory(data.history || []);
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyContainer').innerHTML = 
                    '<small class="text-muted">Error loading history</small>';
            }
        }
        
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<small class="text-muted">No previous sessions found. Generate some questions to see history here.</small>';
                return;
            }
            
            let html = '';
            history.slice(0, 5).forEach(item => {
                const experienceText = item.experience_level ? 
                    `${item.experience_level.charAt(0).toUpperCase() + item.experience_level.slice(1)} Experience` : '';
                
                const dateText = item.timestamp ? 
                    (item.timestamp.seconds ? 
                        new Date(item.timestamp.seconds * 1000).toLocaleDateString() : 
                        new Date(item.timestamp).toLocaleDateString()) : 'Recent';
                
                html += `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${item.job_title}</strong><br>
                            <small class="text-muted">${experienceText} â€¢ ${item.question_count} Questions</small>
                        </div>
                        <small class="text-muted">${dateText}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>